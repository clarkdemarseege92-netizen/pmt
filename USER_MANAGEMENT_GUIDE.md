# 用户管理功能使用指南

## 功能概述

Admin 控制台的用户管理功能允许管理员查看、编辑和管理平台上的所有用户。

## 安装步骤

### 1. 执行数据库迁移

首先需要在 Supabase Dashboard 中执行 SQL 脚本以添加必要的字段：

```bash
# 在 Supabase Dashboard -> SQL Editor 中执行
/database/add_user_management_fields.sql
```

这个脚本会：
- 添加 `is_active` 字段（启用/禁用用户）
- 确保 `role` 字段存在（user/merchant/admin）
- 创建必要的索引以提高性能
- 添加角色约束

### 2. 访问用户管理页面

登录管理员账号后，访问：
```
http://localhost:3000/admin/users
```

或从管理后台侧边栏点击"用户管理"。

## 功能特性

### 1. 用户列表
- 显示所有注册用户
- 显示用户头像、姓名、邮箱、手机号
- 显示用户角色和状态
- 显示注册时间

### 2. 搜索和筛选
- **搜索**: 支持按邮箱、姓名、手机号搜索
- **筛选**: 按角色筛选（全部/普通用户/商户/管理员）

### 3. 角色管理
支持三种角色：
- **普通用户 (user)**: 可以浏览和购买优惠券
- **商户 (merchant)**: 可以创建商品和优惠券
- **管理员 (admin)**: 拥有所有权限

**操作**: 直接在列表中的下拉框选择新角色，自动保存。

### 4. 状态管理
- **正常**: 用户可以正常登录和使用系统
- **禁用**: 用户无法登录（需要在 RLS 策略中实现）

**操作**: 点击状态按钮切换启用/禁用状态。

### 5. 用户详情
点击"查看详情"按钮查看用户完整信息：
- 用户 ID
- 邮箱和手机号
- 注册时间
- 账户状态

### 6. 删除用户
- 点击删除按钮删除用户
- 需要确认操作
- 管理员不能删除自己

## API 端点

### 获取所有用户
```
GET /api/admin/users
```

### 更新用户
```
PATCH /api/admin/users/[id]
Body: {
  role?: 'user' | 'merchant' | 'admin',
  is_active?: boolean
}
```

### 删除用户
```
DELETE /api/admin/users/[id]
```

## 安全性

1. **权限验证**: 所有 API 都验证管理员权限
2. **防止自删**: 管理员不能删除自己的账号
3. **数据验证**: role 字段有数据库级别的约束

## 后续扩展建议

1. **RLS 策略**: 在 Supabase 中添加 RLS 策略，使用 `is_active` 字段阻止被禁用用户的访问
2. **批量操作**: 添加批量启用/禁用/删除功能
3. **用户统计**: 添加用户活跃度、订单数量等统计信息
4. **导出功能**: 导出用户列表为 CSV/Excel
5. **邮件通知**: 在角色变更或账号被禁用时发送邮件通知用户
6. **操作日志**: 记录管理员对用户的操作历史

## 故障排查

### 问题：无法访问用户管理页面
**解决**: 确保登录的账号 role 为 'admin'

### 问题：更新失败
**解决**:
1. 检查是否执行了数据库迁移脚本
2. 检查 Supabase 中 profiles 表的 RLS 策略是否允许管理员操作

### 问题：删除用户后相关数据未删除
**解决**: 需要在数据库中设置级联删除（CASCADE）或在删除前手动清理相关数据
